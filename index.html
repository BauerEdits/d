<!DOCTYPE html>
<html>
<head>
  <title>Fake Sportsbook with Login</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    .bet-line { margin-bottom: 20px; border: 1px solid #ccc; padding: 10px; }
    .bet-line h3 { margin: 0 0 10px 0; }
    .parlay, .history, .login { background: #f0f8ff; padding: 10px; margin-top: 20px; border: 1px solid #aaa; }
    button { margin: 3px; }
    #payoutPreview { font-weight: bold; margin-top: 10px; }
    .checkmark { color: green; font-size: 20px; }
    .xmark { color: red; font-size: 20px; }
  </style>
</head>
<body>
  <h1>Fake Sportsbook (Multi-user Parlay Edition)</h1>

  <!-- Login Options -->
  <div class="login">
    <button onclick="showLoginForm('member')">Member Login</button>
    <button onclick="showLoginForm('admin')">Admin Login</button>
  </div>

  <!-- Member Login Form -->
  <div id="memberLogin" style="display:none">
    <input type="text" id="usernameInput" placeholder="Enter your username">
    <button onclick="loginUser('member')">Log In</button>
  </div>

  <!-- Admin Login Form -->
  <div id="adminLogin" style="display:none">
    <input type="text" id="adminUsernameInput" placeholder="Enter admin username">
    <input type="password" id="adminPasswordInput" placeholder="Enter admin password">
    <button onclick="loginUser('admin')">Log In</button>
  </div>

  <div id="app" style="display:none">
    <p><strong>Balance:</strong> $<span id="balanceDisplay">0</span></p>

    <h2>Create New Bet (Admin Only)</h2>
    <input type="text" id="lineName" placeholder="e.g. Dylan over 20.5 points">
    <input type="text" id="optionA" placeholder="Option A">
    <input type="text" id="optionB" placeholder="Option B">
    <button onclick="createBetLine()">Create Bet</button>

    <h2>Active Betting Lines</h2>
    <div id="lines"></div>

    <div class="parlay">
      <h3>Parlay Cart</h3>
      <ul id="parlayList"></ul>
      <p id="payoutPreview">Potential Payout: N/A</p>
      <button onclick="placeParlay()">Place Parlay Bet</button>
    </div>

    <div class="history">
      <h3>Your Parlay History</h3>
      <div id="parlayHistoryList"></div>
    </div>

    <div class="history">
      <h3>Past Parlays</h3>
      <div id="pastParlayHistoryList"></div>
    </div>
  </div>

  <!-- Display Current User -->
  <div id="currentUserDisplay" style="margin-top: 20px;"></div>

  <script>
    let users = JSON.parse(localStorage.getItem("users")) || {}; // Load users from localStorage
    let currentUser = null;
    let isAdmin = false;

    // Load lines and parlays from localStorage (persisted)
    let lines = JSON.parse(localStorage.getItem("lines")) || [];
    let pastParlays = JSON.parse(localStorage.getItem("pastParlays")) || [];
    let parlayCart = [];

    // Load user login state from localStorage
    window.onload = function() {
        const savedUser = localStorage.getItem("currentUser");
        if (savedUser && users[savedUser]) {
            currentUser = savedUser;
            isAdmin = false;
            document.getElementById("currentUserDisplay").innerText = `Logged in as: ${savedUser}`;
            document.getElementById("app").style.display = 'block';
            renderLines();
            updateBalanceDisplay();
            renderParlayHistory();
            renderPastParlays();
            parlayCart = [];
            renderParlay();
        }

        // Listen for changes to localStorage
        window.addEventListener('storage', function(event) {
            if (event.key === 'lines') {
                renderLines();
            } else if (event.key === 'pastParlays') {
                renderPastParlays();
            } else if (event.key === 'users') {
                renderParlayHistory();
                updateBalanceDisplay();
            }
        });
    };

    // Show the correct login form based on the type (admin or member)
    function showLoginForm(type) {
        if (type === 'member') {
            document.getElementById("memberLogin").style.display = 'block';
            document.getElementById("adminLogin").style.display = 'none';
        } else if (type === 'admin') {
            document.getElementById("adminLogin").style.display = 'block';
            document.getElementById("memberLogin").style.display = 'none';
        }
    }

    // Login function for members and admins
    function loginUser(type) {
        if (type === 'member') {
            const username = document.getElementById("usernameInput").value.trim();
            if (!username) return alert("Please enter a username");
            if (!users[username]) {
                users[username] = { balance: 1000, parlays: [] };
            }
            currentUser = username;
            isAdmin = false;
            // Save user login state to localStorage
            localStorage.setItem("currentUser", username);
            localStorage.setItem("users", JSON.stringify(users));  // Save updated users
            document.getElementById("currentUserDisplay").innerText = `Logged in as: ${username}`;
            document.getElementById("app").style.display = 'block';
            renderLines();
            updateBalanceDisplay();
            renderParlayHistory();
            parlayCart = [];
            renderParlay();
        } else if (type === 'admin') {
            const adminUsername = document.getElementById("adminUsernameInput").value;
            const adminPassword = document.getElementById("adminPasswordInput").value;
            const adminUsernameValid = "admin";
            const adminPasswordValid = "admin123";
            if (adminUsername === adminUsernameValid && adminPassword === adminPasswordValid) {
                isAdmin = true;
                document.getElementById("currentUserDisplay").innerText = `Logged in as Admin`;
                document.getElementById("app").style.display = 'block';
                renderLines();
                updateBalanceDisplay();
                renderParlayHistory();
                renderPastParlays();
                parlayCart = [];
                renderParlay();
            } else {
                alert("Invalid admin credentials");
            }
        }
    }

    function updateBalanceDisplay() {
        document.getElementById("balanceDisplay").innerText = users[currentUser].balance;
    }

    function getParlayMultiplier(legCount) {
        if (legCount === 2) return 3;
        if (legCount === 3) return 6;
        if (legCount === 4) return 10;
        if (legCount === 5) return 15;
        if (legCount >= 6) return 25;
        return 2;
    }

    function createBetLine() {
        if (!isAdmin) {
            return alert("Only admins can create new bet lines.");
        }
        const name = document.getElementById("lineName").value;
        const optionA = document.getElementById("optionA").value;
        const optionB = document.getElementById("optionB").value;

        if (!name || !optionA || !optionB) {
            return alert("Fill all fields!");
        }

        const line = {
            id: Date.now(),
            name,
            optionA,
            optionB,
            result: null
        };

        lines.push(line);
        localStorage.setItem("lines", JSON.stringify(lines)); // Save updated lines to localStorage

        // Trigger the update in other windows via localStorage event
        localStorage.setItem('lines', JSON.stringify(lines));

        renderLines();
    }

    function addToParlay(lineId, side) {
        const existing = parlayCart.find(p => p.lineId === lineId);
        if (existing) return alert("Already added this line to parlay!");
        const line = lines.find(l => l.id === lineId);
        parlayCart.push({ lineId, side, line });
        renderParlay();
    }

    function removeFromParlay(index) {
        parlayCart.splice(index, 1);
        renderParlay();
    }

    function renderParlay() {
        const list = document.getElementById("parlayList");
        list.innerHTML = "";
        parlayCart.forEach((pick, index) => {
            const sideName = pick.side === 'A' ? pick.line.optionA : pick.line.optionB;
            const li = document.createElement("li");
            li.innerHTML = `${pick.line.name}: ${sideName} <button onclick="removeFromParlay(${index})">❌</button>`;
            list.appendChild(li);
        });
        const payoutText = parlayCart.length >= 2
            ? `${getParlayMultiplier(parlayCart.length)}x`
            : "N/A (need at least 2 picks)";
        document.getElementById("payoutPreview").innerText = `Potential Payout: ${payoutText}`;
    }

    function placeParlay() {
        if (parlayCart.length < 2) return alert("Add at least 2 picks for a parlay!");
        const amount = parseInt(prompt("Bet amount?"));
        if (isNaN(amount) || amount <= 0) return;
        if (amount > users[currentUser].balance) return alert("Insufficient balance");

        users[currentUser].balance -= amount;

        const parlay = {
            picks: JSON.parse(JSON.stringify(parlayCart)),
            amount,
            resolved: false,
            result: "Pending"
        };

        users[currentUser].parlays.push(parlay);
        localStorage.setItem("users", JSON.stringify(users)); // Save updated parlays
        // Trigger the update in other windows via localStorage event
        localStorage.setItem('users', JSON.stringify(users));

        parlayCart = [];
        renderParlay();
        updateBalanceDisplay();
        renderParlayHistory();
    }

    function declareWinner(lineId, winner) {
        if (!isAdmin) return alert("Only admins can declare winners.");
        const line = lines.find(l => l.id === lineId);
        if (line.result) return alert("Already resolved");
        line.result = winner;

        // Update user's bets on this line
        for (const user in users) {
            users[user].parlays.forEach(parlay => {
                parlay.picks.forEach(pick => {
                    if (pick.lineId === lineId) {
                        pick.result = (pick.side === winner ? '✅' : '❌');
                    }
                });
            });
        }

        // Check and resolve payouts for members if all legs in a parlay are correct
        for (const user in users) {
            users[user].parlays.forEach(parlay => {
                const allCorrect = parlay.picks.every(pick => pick.result === '✅');
                if (allCorrect && !parlay.resolved) {
                    parlay.resolved = true;
                    const multiplier = getParlayMultiplier(parlay.picks.length);
                    const payout = parlay.amount * multiplier;
                    users[user].balance += payout;
                    parlay.result = `Paid Out: $${payout}`;
                }
            });
        }

        // Save updated data to localStorage
        localStorage.setItem("users", JSON.stringify(users));
        localStorage.setItem("lines", JSON.stringify(lines));
        // Trigger the update in other windows via localStorage event
        localStorage.setItem('lines', JSON.stringify(lines));
        renderLines();
        renderParlayHistory();
    }

    function deleteBetLine(lineId) {
        if (!isAdmin) return alert("Only admins can delete bet lines.");
        const lineIndex = lines.findIndex(l => l.id === lineId);
        if (lineIndex !== -1) {
            const deletedLine = lines.splice(lineIndex, 1)[0];
            // Move parlays associated with deleted line to Past Parlays
            users.forEach(user => {
                user.parlays.forEach(parlay => {
                    if (parlay.picks.some(p => p.lineId === deletedLine.id)) {
                        pastParlays.push(parlay);
                    }
                });
            });
            localStorage.setItem("pastParlays", JSON.stringify(pastParlays)); // Save past parlays
            localStorage.setItem("lines", JSON.stringify(lines)); // Save updated lines
            // Trigger the update in other windows via localStorage event
            localStorage.setItem('lines', JSON.stringify(lines));

            renderLines();
        }
    }

    function renderLines() {
        const container = document.getElementById("lines");
        container.innerHTML = "";
        lines.forEach(line => {
            const div = document.createElement("div");
            div.className = "bet-line";
            div.innerHTML = `
                <h3>${line.name}</h3>
                <button onclick="addToParlay(${line.id}, 'A')">${line.optionA}</button>
                <button onclick="addToParlay(${line.id}, 'B')">${line.optionB}</button>
                <button onclick="declareWinner(${line.id}, 'A')">Set A as Winner</button>
                <button onclick="declareWinner(${line.id}, 'B')">Set B as Winner</button>
                <button onclick="deleteBetLine(${line.id})">Delete</button>
            `;
            container.appendChild(div);
        });
    }

    function renderParlayHistory() {
        const container = document.getElementById("parlayHistoryList");
        container.innerHTML = "";
        const userParlays = users[currentUser].parlays || [];
        userParlays.forEach(parlay => {
            const div = document.createElement("div");
            div.innerHTML = `
                <strong>Parlay (${parlay.picks.length} picks) - Bet: $${parlay.amount}</strong><br>
                <ul>
                    ${parlay.picks.map(p => `<li>${p.line.name}: ${p.side === 'A' ? p.line.optionA : p.line.optionB}</li>`).join('')}
                </ul>
                <p><strong>Result:</strong> ${parlay.result || "Pending"}</p>
            `;
            container.appendChild(div);
        });
    }

    function renderPastParlays() {
        const container = document.getElementById("pastParlayHistoryList");
        container.innerHTML = "";
        pastParlays.forEach(parlay => {
            const div = document.createElement("div");
            div.innerHTML = `
                <strong>Past Parlay (${parlay.picks.length} picks) - Bet: $${parlay.amount}</strong><br>
                <ul>
                    ${parlay.picks.map(p => `<li>${p.line.name}: ${p.side === 'A' ? p.line.optionA : p.line.optionB}</li>`).join('')}
                </ul>
                <p><strong>Result:</strong> ${parlay.result || "Pending"}</p>
            `;
            container.appendChild(div);
        });
    }

  </script>
</body>
</html>